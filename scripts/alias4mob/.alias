#values
export HISTTIMEFORMAT="%F %T ";
export PS1='\[\e[32m\][\[\e[33m\]\u\[\e[31m\]@\[\e[33m\]\h \[\e[34m\]\w \[\e[35m\]\t \[\e[31m\]!\! \[\e[34m\]\s\[\e[32m\]]\[\e[36m\]\$\[\e[0m\] ';
export PATH="/app/sword/schenker/framework/:/app/sword/axway/Integrator/bin/:/app/sword/schenker/testsuite:$PATH";
export CONSOLE_RECORD_DIR="/home/mob/console_record";
export LOG_FILENAME="/home/mob/mob.$(date "+%Y").log";
export ANSIBLE_PATH="/home/mob/SECC_playbooks/MBC_deployer"
export WAITSEC=60;

#alias
alias ..='cd ..';
alias ...='cd ../..';
alias ll='ls -l';
alias l='ls -l';
alias la='ls -la';
alias new='ls -lt | grep -v "^total" | head';
alias old='ls -ltr | grep -v "^total" | head';

#functions definition
function record()
{
  read -p "Please input name for record: " record_name;
  if [[ "${record_name}" != "" ]]; then
    record_name="_${record_name}";
    record_name="$(echo ${record_name} | sed 's/ /_/g')";
  fi
  echo "record_name=0${record_name}0";
  mkdir -p ${CONSOLE_RECORD_DIR};
  NOW=$(date "+%Y%m%d_%H%M%S");
  script --timing=${CONSOLE_RECORD_DIR}/${NOW}${record_name}.time ${CONSOLE_RECORD_DIR}/${NOW}${record_name}.history;
}

function replay()
{
  clear;
  echo "Existing record(s) is/are as below, please input the one you want to replay:";
  seperateLine;
  ls ${CONSOLE_RECORD_DIR} | cut -d\. -f1 | sort | uniq;
  seperateLine;
  read record_name;
  echo "Hint: press \"Ctrl+S\" to pause, press \"Ctrl+Q\" to recover";
  scriptreplay ${CONSOLE_RECORD_DIR}/${record_name}.time ${CONSOLE_RECORD_DIR}/${record_name}.history $1;
}

function log()
{
  time_string=$(date "+[%Y-%m-%d %H:%M:%S]");
  echo "${time_string} $*" >> ${LOG_FILENAME};
}

function seperateLine()
{
  echo "********************************************************************************";
}

function deploy()
{
  if [[ "$1" == "" ]]; then
    dest_system="all";
  else
    dest_system="$1";
  fi
  log "Deployment start. File structure is as below:";
  tree ${ANSIBLE_PATH}/files/ >> ${LOG_FILENAME};
  cd ${ANSIBLE_PATH};
  ansible-playbook deploy.yml -l "${dest_system}";
  echo "Files have been distributed to remote servers, will check compile result ${WAITSEC} seconds later.";
  sleep ${WAITSEC};
  checkCompile "${dest_system}";
  echo "Please use function checkCompile() to check again if needed."
  log "Deployment to ${dest_system} is done.";
  cd;
}

function clean()
{
  echo "File structure before cleaning:";
  tree ${ANSIBLE_PATH}/files/;
  seperateLine;
  find ${ANSIBLE_PATH}/files/ -type f -exec rm -v {} \;;
  seperateLine;
  echo "File structure after cleaning:";
  tree ${ANSIBLE_PATH}/files/;
  log "Deployer server has been cleaned up.";
}

function mcopy()
{
  if [[ $1 != "" && $2 != "" ]]; then
    ori_file="$1";
    dest_path="$2";
    if [[ $3 == "" ]]; then
      dest_system="all";
    else
      dest_system="$3";
    fi
    cd ${ANSIBLE_PATH};
    ansible -m copy -a "src=${ori_file} dest=${dest_path}" "${dest_system}";
    log "Copy ${ori_file} to ${dest_system}:${dest_path}";
    cd;
  fi
}

function mshell()
{
  if [[ $1 != "" ]]; then
    command_line="$1";
    if [[ $2 == "" ]]; then
      dest_system="all";
    else
      dest_system="$2";
    fi
    cd ${ANSIBLE_PATH};
    ansible -m shell -a "${command_line}" "${dest_system}";
    log "Executed ${command_line} on ${dest_system}";
    cd;
  fi
}

function mcompile()
{
  if [[ $2 == "" ]]; then
    dest_system="all";
  else
    dest_system="$2";
  fi
  mbc_name_prefix=$(echo "$1" | cut -d\. -f1);
  if [[ "${mbc_name_prefix}" == "" || "${mbc_name_prefix}" == "all" ]]; then
    mshell "/app/sword/schenker/framework/compileall > /dev/null &" "${dest_system}";
    echo "compileall has been called on remote server(s), will check compile result ${WAITSEC} seconds later.";
    sleep ${WAITSEC};
    checkCompile "${dest_system}";
    echo "Please use command \"checkCompile ${dest_system}\" to check again if needed."
    log "Compileall on ${dest_system}.";
  else
    mshell "cd /app/sword/shared/axway/local/4edi/Compile; c4edi ${mbc_name_prefix}.s4; mv ${mbc_name_prefix}.x4 ../component/;" "${dest_system}";
    log "${mbc_name_prefix} has been compiled on ${dest_system}.";
  fi
}

function checkCompile()
{
  if [[ "$1" == "" ]]; then
      dest_system="all";
    else
      dest_system="$1";
  fi
  cd ${ANSIBLE_PATH};
  ansible -m shell -a 'file=$(ls -t /app/sword/log/compileall_* | head -1); grep "Compilation done" ${file} > /dev/null; if [ $? = 0 ]; then echo -E "Compilation done at $(grep Errors ${file} | cut -d\~ -f1): Errors: $(grep Errors ${file} | cut -d\: -f4-)"; else echo Compilation ongoing $(tail -1 ${file} | grep -oE "\[.*\]"), please check again later; fi' "${dest_system}";
  cd;
}

function serverList()
{
  ansible-inventory --graph -i "${ANSIBLE_PATH}/inventory";
}

function hint()
{
  echo "Alias:";
  alias;
  echo -e "\nServer List:";
  serverList;
  echo -e "\nFunctions:";
  echo "deploy(dest_system=\"all\"): deploy files in folders component/include/lib and check compile result afterwards for target system(default all).";
  echo "clean(): remove files in folders component/include/lib.";
  echo "serverList(): list the servers and groups defined for ansible playbook.";
  echo "mshell(command_line, dest_system=\"all\"), execute given command line(need to be quoted if parameter exists) on target system(default all).";
  echo "mcopy(ori_file, dest_path, dest_system=\"all\"), copy file(absolute path or relative path based on ${ANSIBLE_PATH}) to specific path(absolute path) on target system(default all).";
  echo "mcompile(mbc_name=\"all\", dest_system=\"all\"), compile specific MBC or all MBCs(default all) on target system(default all).";
  echo "checkCompile(dest_system=\"all\"), check compile result on target system(default all).";
}

log ".alias loaded.";
#END
